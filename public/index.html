<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯”èµ›é€‰æ‰‹äººå‘˜åˆ†é…ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <header class="header">
            <h1>æ¯”èµ›é€‰æ‰‹äººå‘˜åˆ†é…ç³»ç»Ÿ</h1>
            <div class="instructions">
                <p>æ‹–æ‹½é€‰æ‰‹å¡ç‰‡åˆ°é˜Ÿä¼ä¸­è¿›è¡Œåˆ†é… | ç‚¹å‡»æ·»åŠ æŒ‰é’®é€‰æ‹©é€‰æ‰‹ | æ”¯æŒæœç´¢å’Œç­›é€‰åŠŸèƒ½</p>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
            <div class="stats-cards">
                <div class="stat-card total-players">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <div class="stat-title">æ€»é€‰æ‰‹æ•°</div>
                        <div class="stat-value" id="totalPlayersCount">0</div>
                    </div>
                </div>
                
                <div class="stat-card unassigned-players">
                    <div class="stat-icon">â³</div>
                    <div class="stat-info">
                        <div class="stat-title">æœªåˆ†é…é€‰æ‰‹</div>
                        <div class="stat-value" id="unassignedPlayersCount">0</div>
                    </div>
                </div>
                
                <div class="stat-card teams">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <div class="stat-title">é˜Ÿä¼æ•°</div>
                        <div class="stat-value" id="teamsCount">0</div>
                    </div>
                </div>
            </div>
            
            <div class="header-actions">
                <div id="userInfo" class="user-info" style="display: none;">
                    <span class="user-name">æ¬¢è¿ï¼Œ<span id="currentUserName"></span></span>
                    <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
                </div>
                <button id="resetBtn" class="btn btn-secondary">é‡ç½®åˆ†é…</button>
                <button id="saveBtn" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                <button id="exportBtn" class="btn btn-secondary">å¯¼å‡ºæ•°æ®</button>
                <button id="importBtn" class="btn btn-secondary">å¯¼å…¥æ•°æ®</button>
                <input type="file" id="importFile" style="display: none;" accept=".json">
            </div>
        </header>
        <!-- ä¸»ä½“å†…å®¹ -->
        <main class="main-content">
            <!-- é˜Ÿä¼å±•ç¤ºåŒº -->
            <section class="teams-section">
            <div class="section-header">
                <h2>é˜Ÿä¼åˆ†é…</h2>
                <div class="section-actions">
                    <button id="addPlayerBtn" class="btn btn-primary">+ æ–°å¢é€‰æ‰‹</button>
                    <button id="addTeamBtn" class="btn btn-primary">+ æ·»åŠ é˜Ÿä¼</button>
                </div>
            </div>
                <div id="teamsContainer" class="teams-container">
                    <!-- é˜Ÿä¼å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
            <!-- æœªåˆ†é…é€‰æ‰‹æ±  -->
            <section class="players-section">
                <div class="section-header">
                    <h2>æœªåˆ†é…é€‰æ‰‹æ± </h2>
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="æœç´¢é€‰æ‰‹æ˜µç§°ã€æ¸¸æˆIDã€ç¾¤æ˜µç§°ã€æ“…é•¿ä½ç½®æˆ–è‹±é›„..." class="search-input">
                        <div class="position-filters">
                            <label><input type="checkbox" class="position-filter" value="ä¼˜åŠ¿è·¯"> ä¼˜åŠ¿è·¯</label>
                            <label><input type="checkbox" class="position-filter" value="ä¸­å•"> ä¸­å•</label>
                            <label><input type="checkbox" class="position-filter" value="åŠ£åŠ¿è·¯"> åŠ£åŠ¿è·¯</label>
                            <label><input type="checkbox" class="position-filter" value="åŠè¾…åŠ©"> åŠè¾…åŠ©</label>
                            <label><input type="checkbox" class="position-filter" value="çº¯è¾…åŠ©"> çº¯è¾…åŠ©</label>
                            <label><input type="checkbox" class="position-filter" value="å…¨æ‰"> å…¨æ‰</label>
                        </div>
                    </div>
                </div>
                <div id="unassignedPlayersContainer" class="players-container">
                    <!-- é€‰æ‰‹å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </main>
    </div>

    <!-- æ·»åŠ é€‰æ‰‹åˆ°é˜Ÿä¼å¯¹è¯æ¡† -->
    <div id="addPlayerModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ é€‰æ‰‹åˆ°é˜Ÿä¼</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="modalSearchInput" placeholder="æœç´¢é€‰æ‰‹..." class="modal-search-input">
                <div id="modalPlayersList" class="modal-players-list">
                    <!-- é€‰æ‰‹åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢é€‰æ‰‹å¯¹è¯æ¡† -->
    <div id="newPlayerModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>æ–°å¢é€‰æ‰‹</h3>
                <button class="modal-close" id="closeNewPlayerModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newPlayerForm" class="new-player-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPlayerNickname">é€‰æ‰‹æ˜µç§° *</label>
                            <input type="text" id="newPlayerNickname" required>
                        </div>
                        <div class="form-group">
                            <label for="newPlayerGameId">æ¸¸æˆID *</label>
                            <input type="text" id="newPlayerGameId" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPlayerGroupNickname">ç¾¤æ˜µç§°</label>
                            <input type="text" id="newPlayerGroupNickname">
                        </div>
                        <div class="form-group">
                            <label for="newPlayerScore">å¤©æ¢¯åˆ†æ•° *</label>
                            <input type="number" id="newPlayerScore" min="0" max="30000" required>
                            <div class="score-preview" id="scorePreview"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ“…é•¿ä½ç½®</label>
                        <div class="position-checkboxes">
                            <label><input type="checkbox" name="positions" value="ä¼˜åŠ¿è·¯"> ä¼˜åŠ¿è·¯</label>
                            <label><input type="checkbox" name="positions" value="ä¸­å•"> ä¸­å•</label>
                            <label><input type="checkbox" name="positions" value="åŠ£åŠ¿è·¯"> åŠ£åŠ¿è·¯</label>
                            <label><input type="checkbox" name="positions" value="åŠè¾…åŠ©"> åŠè¾…åŠ©</label>
                            <label><input type="checkbox" name="positions" value="çº¯è¾…åŠ©"> çº¯è¾…åŠ©</label>
                            <label><input type="checkbox" name="positions" value="å…¨æ‰"> å…¨æ‰</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newPlayerHeroes">æ“…é•¿è‹±é›„</label>
                        <div class="heroes-selector">
                            <div class="selected-heroes" id="selectedHeroes">
                                <!-- å·²é€‰æ‹©çš„è‹±é›„ -->
                            </div>
                            <button type="button" id="selectHeroesBtn" class="btn btn-secondary">é€‰æ‹©è‹±é›„</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPlayerWinRate">æœ€è¿‘èƒœç‡ (%)</label>
                            <input type="number" id="newPlayerWinRate" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="newPlayerChampionships">å† å†›æ•°é‡</label>
                            <input type="number" id="newPlayerChampionships" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é»˜å¥‘é€‰æ‰‹</label>
                        <div class="synergy-selector">
                            <div class="selected-synergy" id="selectedSynergy">
                                <!-- å·²é€‰æ‹©çš„é»˜å¥‘é€‰æ‰‹ -->
                            </div>
                            <button type="button" id="selectSynergyBtn" class="btn btn-secondary">æ·»åŠ é»˜å¥‘é€‰æ‰‹</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelNewPlayer" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»ºé€‰æ‰‹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- è‹±é›„é€‰æ‹©å¯¹è¯æ¡† -->
    <div id="heroesSelectModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©æ“…é•¿è‹±é›„</h3>
                <button class="modal-close" id="closeHeroesModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="heroesSearchInput" placeholder="æœç´¢è‹±é›„åç§°æˆ–åˆ«ç§°..." class="modal-search-input">
                <div class="heroes-list-container">
                    <div id="heroesList" class="heroes-grid">
                        <!-- è‹±é›„åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="cancelHeroesSelect" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button id="confirmHeroesSelect" class="btn btn-primary">ç¡®å®šé€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é»˜å¥‘é€‰æ‰‹é€‰æ‹©å¯¹è¯æ¡† -->
    <div id="synergySelectModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©é»˜å¥‘é€‰æ‰‹</h3>
                <button class="modal-close" id="closeSynergyModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="synergySearchInput" placeholder="æœç´¢é€‰æ‰‹æ˜µç§°..." class="modal-search-input">
                <div id="synergyPlayersList" class="modal-players-list">
                    <!-- é€‰æ‰‹åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="modal-actions">
                    <button id="cancelSynergySelect" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button id="confirmSynergySelect" class="btn btn-primary">ç¡®å®šé€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 - ç¾è§‚çš„å¯¹è¯æ¡†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        class AuthService {
            constructor() {
                this.serverUrl = window.location.origin;
            }

            async login(username, password) {
                try {
                    const response = await fetch(`${this.serverUrl}/api/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, message: data.message };
                    }
                } catch (error) {
                    console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                    return { success: false, message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ' };
                }
            }

            async logout() {
                try {
                    const response = await fetch(`${this.serverUrl}/api/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentUser');
                    
                    return { success: true };
                } catch (error) {
                    console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentUser');
                    return { success: true };
                }
            }

            async checkAuth() {
                try {
                    const localLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                    const localUser = localStorage.getItem('currentUser');
                    
                    if (!localLoggedIn || !localUser) {
                        return { authenticated: false };
                    }

                    const response = await fetch(`${this.serverUrl}/api/check-auth`, {
                        credentials: 'include'
                    });

                    const data = await response.json();
                    
                    if (data.authenticated) {
                        return { authenticated: true, user: data.user };
                    } else {
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('currentUser');
                        return { authenticated: false };
                    }
                } catch (error) {
                    console.error('éªŒè¯è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                    const localLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                    const localUser = localStorage.getItem('currentUser');
                    if (localLoggedIn && localUser) {
                        try {
                            return { authenticated: true, user: JSON.parse(localUser) };
                        } catch (e) {
                            return { authenticated: false };
                        }
                    }
                    return { authenticated: false };
                }
            }

            getCurrentUser() {
                const userStr = localStorage.getItem('currentUser');
                return userStr ? JSON.parse(userStr) : null;
            }

            isLoggedIn() {
                return localStorage.getItem('isLoggedIn') === 'true';
            }
        }

        // åŠ è½½ä¸»è„šæœ¬
        const script = document.createElement('script');
        script.src = '../script.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
